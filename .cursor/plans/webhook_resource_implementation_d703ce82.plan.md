---
name: Webhook Resource Implementation
overview: Add rundeck_webhook resource to manage Rundeck webhooks with full CRUD operations, import support, and consistent plugin configuration patterns.
todos:
  - id: create_resource
    content: Create resource_webhook_framework.go with schema and CRUD operations
    status: pending
  - id: implement_create
    content: Implement Create with auth token capture
    status: pending
  - id: implement_read
    content: Implement Read preserving auth token in state
    status: pending
  - id: implement_update
    content: Implement Update with partial updates support
    status: pending
  - id: implement_delete
    content: Implement Delete operation
    status: pending
  - id: implement_import
    content: Implement ImportState with project/id parsing
    status: pending
  - id: add_tests
    content: Create resource_webhook_test.go with acceptance tests
    status: pending
  - id: add_docs
    content: Create webhook.html.md documentation
    status: pending
  - id: register_resource
    content: Register webhook resource in provider_framework.go
    status: pending
  - id: test_enterprise
    content: Test with Enterprise Rundeck instance
    status: pending
isProject: false
---

# Webhook Resource Implementation Plan

## Overview

Add `rundeck_webhook` resource to manage Rundeck webhooks for triggering automation from external systems. Uses V2 SDK's webhook API (available since API v33) with consistent configuration patterns matching existing job plugins.

## Resource Schema

### Required Attributes

- `project` - Project name that owns the webhook
- `name` - Webhook name (unique within project)
- `user` - Username the webhook executes as
- `roles` - Comma-separated list of roles for authorization
- `event_plugin` - Plugin type (e.g., "run-job-webhook", "log-events-webhook")
- `enabled` - Boolean to enable/disable webhook

### Optional Attributes

- `config` - Map of plugin-specific configuration (map[string]string)

### Computed Attributes

- `id` - Webhook ID (set by Rundeck)
- `auth_token` - Generated authentication token (sensitive, write-only in API)

**Note**: Auth tokens are auto-generated by Rundeck and cannot be specified by users. The token is only visible on creation and should be marked as sensitive.

## Example Usage

```hcl
# Basic webhook to trigger job execution
resource "rundeck_webhook" "deploy" {
  project      = "production"
  name         = "deploy-webhook"
  user         = "automation"
  roles        = "admin,webhook"
  enabled      = true
  event_plugin = "run-job-webhook"
  
  config = {
    jobId     = rundeck_job.deploy.id
    argString = "-env prod"
  }
}

# Log events webhook
resource "rundeck_webhook" "logging" {
  project      = "monitoring"
  name         = "log-events"
  user         = "logger"
  roles        = "user"
  enabled      = true
  event_plugin = "log-events-webhook"
  
  config = {
    logLevel = "INFO"
  }
}

# Webhook with GitHub integration (Enterprise)
resource "rundeck_webhook" "github" {
  project      = "devops"
  name         = "github-webhook"
  user         = "ci-bot"
  roles        = "webhook"
  enabled      = true
  event_plugin = "github-webhook"
  
  config = {
    jobId  = rundeck_job.build.id
    branch = "main"
  }
}
```

## Implementation Files

### New Files

- `rundeck/resource_webhook_framework.go` - Main resource implementation
- `rundeck/resource_webhook_test.go` - Acceptance tests
- `website/docs/r/webhook.html.md` - Documentation

### API Methods (V2 SDK)

Uses `github.com/rundeck/go-rundeck/rundeck-v2` WebhookAPI:

- **Create**: `CreateWebhookDocs(ctx, project)` - Returns webhook with generated auth_token
- **Read**: `Get(ctx, project, id)` - Auth token NOT included in response
- **Update**: `Save(ctx, project, id)` - Partial updates supported
- **Delete**: `Remove(ctx, project, id)` - Returns confirmation
- **List**: `List(ctx, project)` - For import support

## Key Implementation Details

### 1. Auth Token Handling

**Challenge**: Auth tokens are write-only (only visible on creation)

**Solution**:

```go
// On Create - capture and store token
resp, _, err := client.V2.WebhookAPI.CreateWebhookDocs(ctx, project).Body(webhookData).Execute()
state.AuthToken = types.StringValue(resp["authToken"].(string)) // Marked as sensitive

// On Read - token not returned by API
// Don't overwrite state.AuthToken, preserve what was captured on create

// On Update - token unchanged unless regenerated
// Preserve existing token in state unless user requests regeneration
```

### 2. Config Map Handling

Follow existing pattern from job plugins:

```go
// Terraform → API
if !plan.Config.IsNull() {
    var configMap map[string]string
    diags.Append(plan.Config.ElementsAs(ctx, &configMap, false)...)
    webhookData["config"] = configMap
}

// API → Terraform
if configData, ok := apiResp["config"].(map[string]interface{}); ok {
    configAttrs := make(map[string]attr.Value)
    for k, v := range configData {
        if strVal, ok := v.(string); ok {
            configAttrs[k] = types.StringValue(strVal)
        }
    }
    state.Config = types.MapValueMust(types.StringType, configAttrs)
}
```

### 3. Import Support

**Format**: `project/webhook-id`

```bash
terraform import rundeck_webhook.deploy production/a1b2c3d4
```

**Implementation**:

```go
func (r *webhookResource) ImportState(ctx context.Context, req resource.ImportStateRequest, resp *resource.ImportStateResponse) {
    // Split "project/id"
    parts := strings.Split(req.ID, "/")
    if len(parts) != 2 {
        resp.Diagnostics.AddError("Invalid Import ID", 
            "Use format: project/webhook-id")
        return
    }
    
    resp.Diagnostics.Append(resp.State.SetAttribute(ctx, path.Root("project"), parts[0])...)
    resp.Diagnostics.Append(resp.State.SetAttribute(ctx, path.Root("id"), parts[1])...)
}
```

**Note**: Imported webhooks won't have auth_token in state (API doesn't return it). Users should regenerate if needed.

### 4. Plugin Type Validation

**Option A**: No validation (flexible)

- Pro: Works with any plugin, including custom/future plugins
- Con: No early validation, typos caught at API level

**Option B**: Known plugin list (recommended)

- Pro: Better UX with clear error messages
- Con: Requires maintenance for new plugins

**Recommendation**: Start with Option A, add validation in future version if needed.

## Testing Strategy

### Unit Tests

- Schema validation
- Config map conversion (Terraform ↔ API)
- Import ID parsing
- Auth token sensitivity handling

### Acceptance Tests

**Test Scenarios**:

1. **Basic CRUD** - Create, read, update, delete webhook
2. **Run Job Plugin** - Most common use case
3. **Log Events Plugin** - Alternative plugin type
4. **Enable/Disable** - Toggle webhook state
5. **Config Updates** - Modify plugin configuration
6. **Import Existing** - Import webhook by ID
7. **Multiple Webhooks** - Multiple webhooks in same project

**Enterprise Tests** (skip in OSS CI):

- GitHub webhook plugin
- Advanced run job webhook
- PagerDuty/Datadog integrations

### Test Configuration Example

```hcl
resource "rundeck_project" "test" {
  name = "terraform-acc-test-webhook"
  resource_model_source {
    type = "file"
    config = {
      file = "/tmp/resources.xml"
    }
  }
}

resource "rundeck_job" "test" {
  project_name = rundeck_project.test.name
  name         = "test-job"
  description  = "Test job for webhook"
  
  command {
    shell_command = "echo 'triggered by webhook'"
  }
}

resource "rundeck_webhook" "test" {
  project      = rundeck_project.test.name
  name         = "test-webhook"
  user         = "admin"
  roles        = "admin"
  enabled      = true
  event_plugin = "run-job-webhook"
  
  config = {
    jobId = rundeck_job.test.id
  }
}
```

## Documentation Requirements

### Resource Documentation (`website/docs/r/webhook.html.md`)

**Sections**:

1. **Overview** - Purpose and use cases
2. **Example Usage** - Common scenarios (job trigger, logging, GitHub)
3. **Argument Reference** - All attributes with descriptions
4. **Attribute Reference** - Computed values
5. **Import** - Import syntax and limitations
6. **Plugin Types** - List of common plugins with config examples
7. **Security Notes** - Auth token handling best practices

**Common Plugins to Document**:

- `run-job-webhook` - Trigger job execution
- `log-events-webhook` - Log incoming events
- `github-webhook` - GitHub integration (Enterprise)
- `pagerduty-webhook` - PagerDuty integration (Enterprise)
- `advanced-run-job` - Advanced job triggering (Enterprise)

## Edge Cases & Considerations

### 1. Auth Token Regeneration

- If user needs new token, delete and recreate webhook
- Document this in resource docs
- Future enhancement: Add `regenerate_auth_token` trigger

### 2. Plugin Config Validation

- Rundeck validates plugin config at API level
- Provider passes through validation errors
- Document common config fields per plugin

### 3. Role Authorization

- Webhook executes with specified roles
- Ensure roles have permission for plugin actions
- Document in security notes

### 4. Duplicate Names

- Rundeck allows duplicate webhook names in same project
- Provider should work with this (uses ID, not name)
- Consider adding validation warning in docs

### 5. Disabled Webhooks

- Disabled webhooks return 404 when triggered
- Config preserved when disabled
- Can be re-enabled without data loss

## Migration Path from Manual Webhooks

**For users with existing webhooks**:

1. Use `terraform import` to bring into state:
  ```bash
   terraform import rundeck_webhook.existing project-name/webhook-id
  ```
2. Write Terraform config matching existing webhook:
  ```hcl
   resource "rundeck_webhook" "existing" {
     project      = "project-name"
     name         = "existing-webhook"
     user         = "automation"
     roles        = "webhook"
     enabled      = true
     event_plugin = "run-job-webhook"
     config = {
       jobId = "job-uuid"
     }
   }
  ```
3. Run `terraform plan` to verify no changes

**Note**: Auth token won't be in state after import. If needed, users should:

- Note the existing token from Rundeck UI before import
- Or delete/recreate to get new token

## Future Enhancements (Not in v1.2)

1. **Data Source** - `data.rundeck_webhook` to reference existing webhooks
2. **Auth Token Rotation** - Trigger to regenerate tokens
3. **Plugin Schema Validation** - Validate config per plugin type
4. **Webhook Events Data Source** - Query debug events (Enterprise)
5. **Bulk Operations** - Manage multiple webhooks efficiently

## Success Criteria

✅ Resource creates webhooks successfully
✅ Auth tokens captured and marked sensitive
✅ Config map handles all plugin types
✅ Import works for existing webhooks
✅ Update operations preserve auth tokens
✅ Documentation covers common use cases
✅ Tests pass in Enterprise environment
✅ Consistent with existing job plugin patterns